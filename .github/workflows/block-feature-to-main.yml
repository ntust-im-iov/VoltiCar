name: Block Feature PR to Main

on:
  pull_request:
    branches: [main]

jobs:
  block-feature-to-main:
    name: Block feature/* -> main PR
    runs-on: self-hosted

    steps:
      - name: Check source and target branches
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          echo "ğŸ” æª¢æŸ¥æ˜¯å¦ç‚ºä¸å…è¨±çš„åˆä½µè·¯å¾‘..."

          HEAD_REF="${{ github.head_ref }}"
          BASE_REF="${{ github.base_ref }}"

          echo "ä¾†æºåˆ†æ”¯: $HEAD_REF"
          echo "ç›®æ¨™åˆ†æ”¯: $BASE_REF"

          if [[ "$HEAD_REF" =~ ^feature/ && "$BASE_REF" == "main" ]]; then
            echo "âŒ é•è¦åˆä½µï¼æ­£åœ¨ç™¼é€ Discord é€šçŸ¥..."

            curl -H "Content-Type: application/json" \
              -X POST \
              -d "{
                \"embeds\": [{
                  \"title\": \"âŒ é•è¦åˆä½µé˜»æ“‹ï¼šfeature/* â†’ main\",
                  \"description\": \"\
                  ğŸ” **ä¾†æºåˆ†æ”¯**ï¼š\`$HEAD_REF\`\n\
                  ğŸ“¥ **ç›®æ¨™åˆ†æ”¯**ï¼š\`$BASE_REF\`\n\
                  ğŸ‘¤ **ä½œè€…**ï¼š\`${{ github.actor }}\`\n\n\
                  ğŸš« æ­¤è·¯å¾‘ä¸å…è¨±åˆä½µï¼è«‹æ”¹åˆä½µè‡³ \`develop\` åˆ†æ”¯ã€‚\n\
                  ğŸ”— [æŸ¥çœ‹ PR è©³æƒ…](${{ github.event.pull_request.html_url }})\",
                  \"color\": 16711680
                }]
              }" \
              $DISCORD_WEBHOOK

            exit 1
          else
            echo "âœ… åˆä½µè·¯å¾‘åˆæ³•"
          fi
